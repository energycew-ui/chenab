<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Smart Energy Dashboard</title>

<script src="https://unpkg.com/feather-icons"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"/>

<style>
  .card:hover {
    transform: scale(1.05);
    transition: .3s;
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
  }
  body {
    font-size: 1.06rem;
    background-image: url('https://chenabengineering.com/wp-content/uploads/2023/06/istockphoto-1147790557-612x612-1.jpg');
    background-size: cover;
    background-position: center;
    background-attachment: fixed;
  }
</style>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, onValue, off, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyApTAM7ZAvxHBDjVNFe7ARN5iNtshA8TFQ",
    authDomain: "energy-monitoring-chenab-60e72.firebaseapp.com",
    databaseURL: "https://energy-monitoring-chenab-60e72-default-rtdb.firebaseio.com",
    projectId: "energy-monitoring-chenab-60e72"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  /* ===================== FIELDS ===================== */
  const fields = [
    "VOLTAGE_AB","VOLTAGE_BC","VOLTAGE_CA",
    "AVERAGE_PHASE_VOLTAGE",
    "L1_Voltage","L2_Voltage","L3_Voltage",
    "AVERAGE_VOLTAGE",
    "current_phase_1","current_phase_2","current_phase_3",
    "Average_current",
    "POWER_PHASE_A","POWER_PHASE_B","POWER_PHASE_C",
    "TOTAL_POWER",
    "FREQUENCY",
    "PowerFactorTotal",
    "TotalKWh",
    "Present_Demand",
    "Maximum_Demand_kW",
    "Maximum_Demand_DateTime"
  ];

  /* ===================== ICONS ===================== */
  const icons = {
    VOLTAGE_AB:"zap",VOLTAGE_BC:"zap",VOLTAGE_CA:"zap",
    AVERAGE_PHASE_VOLTAGE:"zap",
    L1_Voltage:"zap",L2_Voltage:"zap",L3_Voltage:"zap",
    AVERAGE_VOLTAGE:"zap",
    current_phase_1:"activity",current_phase_2:"activity",current_phase_3:"activity",
    Average_current:"activity",
    POWER_PHASE_A:"battery-charging",
    POWER_PHASE_B:"battery-charging",
    POWER_PHASE_C:"battery-charging",
    TOTAL_POWER:"battery",
    FREQUENCY:"refresh-cw",
    PowerFactorTotal:"percent",
    TotalKWh:"database",
    Present_Demand:"activity",
    Maximum_Demand_kW:"trending-up",
    Maximum_Demand_DateTime:"clock"
  };

  /* ===================== COLORS ===================== */
  const fieldColors = {
    VOLTAGE_AB:"bg-blue-100",VOLTAGE_BC:"bg-blue-100",VOLTAGE_CA:"bg-blue-100",
    AVERAGE_PHASE_VOLTAGE:"bg-blue-100",
    L1_Voltage:"bg-blue-100",L2_Voltage:"bg-blue-100",L3_Voltage:"bg-blue-100",
    AVERAGE_VOLTAGE:"bg-blue-100",
    current_phase_1:"bg-yellow-100",current_phase_2:"bg-yellow-100",current_phase_3:"bg-yellow-100",
    Average_current:"bg-yellow-100",
    POWER_PHASE_A:"bg-orange-100",POWER_PHASE_B:"bg-orange-100",POWER_PHASE_C:"bg-orange-100",
    TOTAL_POWER:"bg-orange-100",
    FREQUENCY:"bg-indigo-100",
    PowerFactorTotal:"bg-green-100",
    TotalKWh:"bg-red-100",
    Present_Demand:"bg-purple-100",
    Maximum_Demand_kW:"bg-red-200",
    Maximum_Demand_DateTime:"bg-gray-200"
  };

  /* ===================== PM5300 DATETIME FIX ===================== */
 function normalizePM5300DateTime(raw) {
  if (!raw || typeof raw !== "string") return raw;

  // PM5300 format strictly: DD/MM/YY HH:MM:SS
  const m = raw.trim().match(
    /^(\d{2})[\/\-](\d{2})[\/\-](\d{2})\s+(\d{2}):(\d{2}):(\d{2})$/
  );

  if (!m) return raw;

  let dd = parseInt(m[1], 10);
  let mm = parseInt(m[2], 10);
  let yy = parseInt(m[3], 10);
  let hh = parseInt(m[4], 10);
  let mi = parseInt(m[5], 10);
  let ss = parseInt(m[6], 10);

  // PM5300 year fix
  yy += 2000;

  // ðŸ”’ HARD VALIDATION (NO JS MAGIC)
  if (
    dd < 1 || dd > 31 ||
    mm < 1 || mm > 12 ||
    hh > 23 || mi > 59 || ss > 59
  ) {
    return raw;
  }

  // ðŸ”’ Build ISO string manually
  const iso =
    `${yy}-${String(mm).padStart(2, "0")}-${String(dd).padStart(2, "0")}` +
    `T${String(hh).padStart(2, "0")}:${String(mi).padStart(2, "0")}:${String(ss).padStart(2, "0")}`;

  const dt = new Date(iso);
  if (isNaN(dt.getTime())) return raw;

  return dt.toLocaleString("en-PK", {
    day: "2-digit",
    month: "short",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit",
    hour12: true,
    timeZone: "Asia/Karachi"
  });
}


  /* ===================== ELEMENTS ===================== */
  const cards = document.getElementById("cards");
  const pathSelector = document.getElementById("pathSelector");
  const clockEl = document.getElementById("clock");

  /* ===================== CHART SETUP ===================== */
  const labels = [];
  let voltageChart, currentChart, powerChart;

  function createChart(ctx, label, color) {
    return new Chart(ctx, {
      type: "line",
      data: { labels, datasets: [{ label, data: [], borderColor: color, borderWidth: 3, tension: 0.4, pointRadius: 2 }] },
      options: { responsive:true, animation:false, plugins:{ legend:{ display:false } } }
    });
  }

  function initCharts() {
    voltageChart = createChart(document.getElementById("voltageChart"), "Average Voltage (V)", "rgb(59,130,246)");
    currentChart = createChart(document.getElementById("currentChart"), "Average Current (A)", "rgb(251,146,60)");
    powerChart   = createChart(document.getElementById("powerChart"), "Total Power (kW)", "rgb(34,197,94)");
  }

  function updateCharts(d) {
    const t = new Date().toLocaleTimeString("en-PK",{hour12:false});
    if (labels.length > 50) {
      labels.shift();
      voltageChart.data.datasets[0].data.shift();
      currentChart.data.datasets[0].data.shift();
      powerChart.data.datasets[0].data.shift();
    }
    labels.push(t);
    voltageChart.data.datasets[0].data.push(d.AVERAGE_VOLTAGE || 0);
    currentChart.data.datasets[0].data.push(d.Average_current || 0);
    powerChart.data.datasets[0].data.push(d.TOTAL_POWER || 0);
    voltageChart.update('none');
    currentChart.update('none');
    powerChart.update('none');
  }

  /* ===================== CARDS ===================== */
  function updateCards(data) {
    cards.innerHTML = "";
    fields.forEach(f => {
      if (data[f] === undefined) return;
      const d = document.createElement("div");
      d.className = `card p-4 rounded-xl shadow-lg ${fieldColors[f] || "bg-white"} text-center`;
      d.innerHTML = `
        <div class="flex justify-center mb-2 text-3xl text-gray-700">
          <i data-feather="${icons[f] || "box"}"></i>
        </div>
        <h2 class="text-sm font-bold">${f.replace(/_/g,' ')}</h2>
        <p class="text-2xl font-bold mt-1">
          ${
            f === "Maximum_Demand_DateTime"
              ? normalizePM5300DateTime(data[f])
              : (typeof data[f] === "number" ? Number(data[f]).toFixed(2) : data[f])
          }
          ${["VOLTAGE_AB","VOLTAGE_BC","VOLTAGE_CA","AVERAGE_VOLTAGE","L1_Voltage","L2_Voltage","L3_Voltage","AVERAGE_PHASE_VOLTAGE"].includes(f) ? " V" : ""}
          ${["current_phase_1","current_phase_2","current_phase_3","Average_current"].includes(f) ? " A" : ""}
          ${["POWER_PHASE_A","POWER_PHASE_B","POWER_PHASE_C","TOTAL_POWER","Present_Demand","Maximum_Demand_kW"].includes(f) ? " kW" : ""}
          ${f === "TotalKWh" ? " kWh" : ""}
          ${f === "FREQUENCY" ? " Hz" : ""}
        </p>`;
      cards.appendChild(d);
    });
    feather.replace();
  }

  /* ===================== DATA ===================== */
  let lastPath = null;
  function loadData(p) {
    if (lastPath) off(ref(db, lastPath));
    lastPath = p;
    onValue(ref(db, p), snap => {
      const d = snap.val();
      if (!d) return;
      updateCards(d);
      updateCharts(d);
    });
  }

  async function loadPaths() {
    const snap = await get(ref(db));
    const data = snap.val() || {};
    pathSelector.innerHTML = "";
    Object.keys(data).forEach(p => {
      const o = document.createElement("option");
      o.value = p;
      o.textContent = p.replace(/_/g,' ');
      pathSelector.appendChild(o);
    });
    if (pathSelector.value) loadData(pathSelector.value);
  }

  function updateClock() {
    clockEl.textContent = new Date().toLocaleString("en-PK",{timeZone:"Asia/Karachi"});
  }
  setInterval(updateClock,1000);
  updateClock();

  pathSelector.addEventListener("change",()=>loadData(pathSelector.value));
  window.addEventListener("load",()=>{ initCharts(); loadPaths(); });

</script>
</head>

<body class="text-gray-800 min-h-screen">

<header class="bg-green-700 text-white p-4">
  <div class="container mx-auto flex justify-between items-center">
    <div>
      <label>Select Section:</label>
      <select id="pathSelector" class="text-black p-2 rounded ml-2"></select>
    </div>
    <div class="text-center">
      <h1 class="text-2xl font-bold">Smart Energy Dashboard</h1>
      <div id="clock" class="text-sm"></div>
    </div>
  </div>
</header>

<main class="p-6 container mx-auto">
  <section id="cards" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-10"></section>

  <section class="grid grid-cols-1 md:grid-cols-3 gap-8">
    <div class="bg-white p-6 rounded-xl shadow-xl">
      <h2 class="text-center text-xl font-bold mb-4 text-blue-600">Live Voltage</h2>
      <canvas id="voltageChart"></canvas>
    </div>
    <div class="bg-white p-6 rounded-xl shadow-xl">
      <h2 class="text-center text-xl font-bold mb-4 text-orange-600">Live Current</h2>
      <canvas id="currentChart"></canvas>
    </div>
    <div class="bg-white p-6 rounded-xl shadow-xl">
      <h2 class="text-center text-xl font-bold mb-4 text-green-600">Live Power</h2>
      <canvas id="powerChart"></canvas>
    </div>
  </section>
</main>

</body>
</html>


